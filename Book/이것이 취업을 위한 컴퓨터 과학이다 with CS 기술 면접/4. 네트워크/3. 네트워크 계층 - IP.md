# 네트워크 계층 - IP

IP는 네트워크 계층의 가장 핵심적인 프로토콜이다. 

# IP의 목적과 특징

IP의 본래 목적은 크게 주소지정과 단편화, 2가지로 나뉩니다. “”주소지정””은 네트워크 간의 통신 과정에서 호스트를 특정하는 것을 의미하고, 단편화는 여러 IP 패킷으로 올바르게 쪼개어 보내는 것을 의미합니다.  또한 IP는 ‘신뢰할 수 없는 통신’과 ‘비연결형 통신’이라는 중요한 특징을 가지고 있습니다. 

## 주소 지정과 단편화

## 주소 지정

주소 지정은 IP 주소를 통해 이루어지며, 이는 IP 패킷 헤더를 통해 알 수 있습니다.  송신지 IP 주소와 수신지 IP 주소 필드에는 송수신지를 식별할 수 있는 IP 주소가 명시됩니다. 

하나의 IP 주소는 총 4바이트(32비트)의 크기로 구성되고, 숫자당 8비트로 표현되므로 0~255 범위의 10진수 4개로 표기됩니다. 각각의 10진수는 점(.)으로 구분하는데, 여기서 점으로 구분된 하나의 10진수를 “”옥텟””이라고 합니다. 

패킷을 올바르게 전송하기 위해서는 MAC 주소와 IP 주소가 모두 필요합니다. 패킷의 송수신 과정에서도 MAC 주소보다는 IP 주소가 우선적으로 활용됩니다. 

### 라우터

서로 다른 네트워크에 속한 두 호스트가 네트워크 간 통신을 수행할 때, IP 주소를 바탕으로 목적지까지 IP 패킷을 전달하는 네트워크 장비로 “”라우터””가 있습니다. 

라우터는 네트워크 계층에 속한 핵심 장비로, 전달받은 패킷을 목적지까지 전달하는 역할을 수행합니다. 이때 라우터는 IP 패킷을 전달할 최적의 경로를 결정하고 해당 경로로 내보낼 수 있어야 하는데, 이 과정을 “”라우팅””이라고 합니다. 

즉, 라우터는 IP 주소를 기반으로 패킷의 최적 경로를 결정하여 목적지까지 전달하는 네트워크 장비입니다. 

## 단편화

IP 단편화를 이해하려면 MTU라는 단위를 먼저 이해해야 합니다. MTU는 말 그대로 최대 전송 단위를 의미합니다. 전송하고자 하는 IP 패킷의 크기가 MTU라는 단위보다 클 경우에는 패킷을 MTU 이하의 여러 패킷으로 쪼개서 전송하고, 이렇게 쪼개서 전송된 패킷들은 수신지에서 재조합됩니다. 

IP 패킷 헤더에서 단편화와 관련된 필드는 식별자, 플래그, 단편화 오프셋입니다. 

1. 식별자: 특정 패킷이 어떤 데이터에서 쪼개진 패킷인지를 식별하기 위해 사용되는 필드입니다. 같은 정보에서 쪼개진 패킷들은 같은 식별자를 공유하기 때문에 식별자를 통해 단편화되어 전송되는 패킷을 구분할 수 있습니다. 
2. 플래그: 3비트로 구성된 필드로, 첫 번째 비트를 제외한 나머지 2개의 비트는 각각 DF와 MF라는 이름이 붙어 있습니다. 첫 번째 비트는 항상 0으로 설정되어 오늘날 사용되지 않고, DF는 ‘IP 단편화를 수행하지 말라’, MP는 ‘단편화된 패킷이 더 있다’는 표시를 남기기 위한 비트입니다. 
3. 단편화 오프셋: 특정 패킷이 초기 데이터에서 얼마나 떨어져 있는지가 명시된 필드로, 단편화되어 전송되는 패킷을 목적지에서 재조합하기 위해 패킷의 올바른 순서를 나타내는 데 사용됩니다. 

## 신뢰할 수 없는 통신과 비연결형 통신

### 신뢰할 수 없는 통신

신뢰할 수 없는 프로토콜이란 패킷이 수신지까지 제대로 전송되었다고 보장되지 않는 프로토콜을 의미합니다. 패킷이 유실되거나 목적지에 순서대로 전송되지않더라도 이에 대한 조치를 취하지 않는 것을 의미합니다. 그리고 이는 최선형 전달이라고 부릅니다. 

### 비연결형 프로토콜

이는 패킷을 주고받기 전에 사전 연결 과정을 거치지 않는 것을 나타냅니다. 따라서 상대 호스트의 수신 가능 여부는 고려하지 않고, 수신지를 향해 그저 패킷을 전송할 뿐입니다. 

---

# IP 주소의 구조

## 클래스풀 주소 체계

IP 주소에서 네트워크 주소와 호스트 주소를 구분하는 범위가 유동적일 수 있다면 둘의 크기는 어느 정도가 적당할까요? 답은 ‘상황에 따라 다르다’입니다. 이처럼 이러한 고민을 해결하기 위해 생겨난 개념이 IP 주소의 클래스입니다. 

클래스는 네트워크 크기에 따라 유형별로 IP주소를 분류하는 기준입니다. 어떤 클래스에 속한 IP 주소인지를 알면 IP 주소에서 네트워크 부분과 호스트 부분이 어느정도의 크기인지 알 수 있습니다. 

클래스는 A,B,C,D,E 총 5개 종류가 있습니다. 이 중 D와 E클래스는 각각 멀티캐스트를 위한 클래스로, 특수한 목적을 위해 예약된 클래스이기 때문에 네트워크의 크기별로 IP를 분류하는데 실질적으로 사용되는 클래스는 A,B,C입니다. 이러한 클래스를 바탕으로 IP 주소를 관리하는 주소체계를 클래스풀 주소 체계라고 합니다. 

## 클래스리스 주소 체계와 서브넷 마스크

클래스풀 주소 체계 하에서는 클래스별 네트워크 크기가 고정되어 있습니다. 이렇게 클래스별 네트워크 크기가 고정되어 있을 때는 고정된 크기 이외에 다른 크기의 네트워크를 구성할 수 없어 IP 주소가 낭비될 수 있다는 한계가 있습니다. 

이러한 문제를 해결하기 위한 수단이 클래스리스 주소 체계입니다.말 그래도 클래스를 이용하지 않고 네트워크와 호스트를 구분하는 방식입니다.  클래스리스 주소 체계에서는 네트워크와 호스트를 구분하는 수단으로 서브넷 마스크를 이용합니다. 

- 서브넷 마스크: IP 주소상에서 네트워크 주소를 1로 표기하고 호스트 주소를 0으로 표기한 비트열 / 즉, 서브넷 마스크는 곧 서브넷을 구분하는 비트열임
- 서브네트워크(서브넷): IP 주소에서 네트워크 주소로 구분할 수 있는 네트워크의 부분집합을 의미
- 서브넷 마스크: 서브넷을 구분하는 비트열
- 서브네팅: 서브넷 마스크를 이용해 원하는 크기로 클래스를 더 잘게 쪼개어 사용하는 것

---

# 공인 IP 주소와 사설 IP 주소

## 공인 IP 주소

공인 IP 주소는 전 세계에서 고유한 IP 주소입니다. 인터넷을 비롯한 네트워크 간 통신에서 사용되는 IP 주소입니다.  공인 IP 주소는 ISP나 공인 IP 주소 할당 기관을 통해 할당받을 수 있습니다. 

## 사설 IP 주소

사설 IP 주소는 사설 네트워크에서 사용하기 위한 IP 주소입니다. 사설 네트워크란 외부 네트워크에 공개되지 않은 네트워크를 의미합니다. 

---

# IP 주소 할당

호스트에 IP 주소를 할당하는 방법은 크게 2가지인데 하나는 정적할당이고, 또 하나는 동적 할당입니다. 전자는 수작업을 통해 이루어지고, 후자는 일반적으로 DHCP라는 프로토콜을 통해 이루어집니다. 

## 정적 할당

정적할당은 직접 수작업으로 IP 주소를 부여하는 방식으로, 정적 할당을 통해 할당된 IP 주소를 정적 IP 주소라고 합니다. 

정적 IP 주소를 부여하기 위해 필요한 값으로는 일반적으로 정적 IP 주소를 부여하고자 하는 IP 주소와 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소 등이 필요한데, 이 값은 운영체제에 상관없이 대체적으로 유사합니다.  

게이트웨이는 일반적으로 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단을 의미합니다. 그 중에서도 기본 게이트웨이는 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로를 의미합니다. 따라서 기본 게이트웨이는 네트워크 외부와 연결된 라우터의 주소를 의마하는 경우가 많습니다. 

### DNS 주소

DNS 주소는 호스트가 도메인 네임을 토대로 IP 주소를 알아내기 위해 질이하는 서버의 주소를 의미합니다. 

기본적으로 호스트끼리 패킷을 주고받기 위해서는 IP 주소가 사용되지만, 통신을 주고받는 모든 호스트의 IP 주소를 기억하기 어렵습니다. 따라서 IP 주소에 대응되는 기억할 수 있는 문자열로 호스트를 식별할 수 있으며, 이를 **“”도메인 네임””**이라고 합니다. 

호스트가 도메인 네임을 토대로, 이에 대응되는 IP주소를 알아내려면 <도메인 네임, IP 주소> 쌍을 저장하는 서버에 질의해야 합니다. 이 서버를 DNS 서버라고 부릅니다. 

## 동적 할당

동적 할당은 프로토콜을 통해 자동으로 IP 주소를 부여하는 방식으로, 동적 할당을 통해 할당된 IP 주소를 동적 IP 주소라고 합니다. 이 과정에서 가장 흔히 사용되는 프로토콜이 DHCP 입니다. 

일상적으로 동적 IP 주소가 많이 사용되는 만큼, DHCP 또한 빈번히 사용됩니다. IP 주소를 동적으로 할당받고자 하는 호스트는 DHCP 서버와 메세지를 주고받으며 동적 IP 주소를 할당받을 수 있습니다. 

**DHCP 서버**: 호스트에 할당 가능한 IP 주소 목록을 관리하다가, IP 주소 할당 요청을 받았을 때 IP 주소를 할당해 주는 호스트로, 일반적으로 라우터가 DHCP 서버 역할을 수행합니다. 

### 동적 할당과 이를 통해 부여되는 동적 IP 주소와 관련해 기억해야할 2가지

1. 동적 IP 주소에는 사용 가능한 기간(임대 기간)이 정해져있다.
2. 동적 IP 주소는 할당받을 때마다 다른 주소를 받을 수 있다. 

DHCP로 할당받은 IP 주소는 사용할 기간이 정해져있고, 사용되지 않을 경우 회수됩니다. 사용 기간이 끝난 IP 주소는 DHCP 서버로 반납되고, 새롭게 IP 주소를 할당받는 경우 다른 IP 주소를 할당받을 수 있습니다.  참고로 IP 주소의 임대 기간이 끝나기 전에 임대 기간을 연장할 수도 있습니다. 이를 임대 갱신이라고 합니다. 

# IP 전송 특징의 보완: ICMP

### IP의 신뢰할 수 없는 비연결성 통신이라는 특징을 보완해야할 경우

1. 신뢰할 수 있는 연결형 통신을 지원하는 상위 계층의 프로토콜을 이용하는 것으로 대표적으로 TCP가 있음
2. 네트워크 계층의 프로토콜로 **ICMP**를 이용하는 방법임. 

**“”ICMP””**는 IP 패킷의 전송 과정에 대한 피드백 메세지를 얻기 위해 사용하는 프로토콜로, ICMP 메세지를 통해 패킷이 상대방에게 어떻게 전송되었는지를 알려줄 수 있어 IP 전송의 결과를 엿볼 수 있습니다. 

ICMP 메세지는 크게 전송 과정에서 발생한 오류 보고와 네트워크에 대한 진단 정보로 유형을 나눌 수 있습니다. 

# IP 주소와 MAC 주소의 대응: ARP

### ARP

ARP는 IP 주소와 MAC 주소를 함께 활용하는 통신 과정에서 동일 네트워크 내에 있는 송수신 대상의 IP 주소를 통해 MAC 주소를 알아내는 프로토콜입니다. 

### ARP 프로토콜의 동작 과정

ARP의 동작 과정, 즉 IP 주소를 통해 모르는 MAC 주소를 알아내는 과정은 **ARP 요청 메세지**와 **ARP 응답 메세지**를 통해 이루어집니다. 

ARP 요청 메세지는 브로드캐스트 메시지입니다. 다시 말해, 네트워크 내에 있는 모든 호스트에게 보내는 메세지입니다.  ARP 요청 메세지에는 알고 싶은 MAC 주소에 대응되는 IP 주소가 포함되어 있습니다. 

ARP 요청 메세지는 브로드캐스트 메시지이기에 네트워크 내의 몯느 호스트가 이를 수신합니다. 이때 호스트들은 APR 요청 메세지에 포함된 IP 주소를 확인해 자신과 관련이 없는 IP 주소일 경우에는 무시하고, 자신의 IP 주소일 경우에는 ARP 응답 메세지를 전송합니다. APR 응답 메세지에는 응답 메세지를 보내는 호스트의 MAC 주소가 포함되어 있습니다. 

이때 호스트 입장에서는 ARP 요청 메세지와 ARP 응답 메세지를 주고 받으며 알게 된 <IP 주소, MAC 주소> 쌍을 기억해 두는 것이 좋습니다. 그렇지 않으면 나중에 같은 호스트에게 패킷을 보내야 할 때마다 브로드캐스트(ARP) 요청메세지를 보내야하기 때문입니다. 

그래서 ARP를 활용하는 호스트는 APR 테이블이라는 정보를 유지합니다. ARP 테이블은 <IP 주소, MAC 주소>의 항목들로 구성된 표 형태의 정보입니다.