# 동기화와 교착 상태

동일한 프로세스의 스레드 A와 B가 있고, 각각의 프로세스가 할당받은 파일을 수정하는 경우, 두 스레드는 파일 자원을 공유하고 있는 셈이다. 

이렇게 프로세스 혹은 스레드가 공유하는 자원은 말 그대로 공유 자원이라고 한다. 
만약 공유자원을 두고 동시다발적으로 실행되는 다수의 프로세스 혹은 스레드가 마구잡이로 실행되면 다수의 프로세스 혹은 스레드가 동시에 공유 자원에 접근할 경우 실행에 문제가 발생할 수 있다. 

공유자원에 접근하는 코드 중 동시에 실행했을 때 문제가 발생할 수 있는 코드는 임계 구역이라고 한다. 

즉, 동시에 실행되는 프로세스나 스레드가 동시에 임계 구역에 진입하여 실행되면 문제가 발생할 수 있다. 

### 예시

예를 들어 프로세스 A가 실행된 뒤 프로세스 B가 실행되는 것은 문제가 되지 않는다. 하지만 반대로 프로세스 B가 실행된 뒤에 프로세스 A가 실행되는 것은 문제가 될 수 있다. 아직 쓰이지 않은 메모리를 읽으려 했기 때문이다. 
>> 즉, 프로세스 A의 ‘공유 메모리 공간에 데이터를 쓰는 코드’와 프로세스 B의 ‘공유 메모리 공간을 읽는 코드’는 임계 구역이 된다. 

이처럼 동시다발적으로 실행되는 프로세스 혹은 스레드를 다룰 때는 언제나 임계 구역을 동시에 실행하지 않도록 유의 해야한다. 

### 레이스 컨디션

앞선 예시처럼 프로세스 혹은 스레드가 동시에 임계 구역의 코드를 실행하여 문제가 발생하는 상황

레이스 컨디션이 발생하면 자원의 일관성이 손상될 수 있기 때문에 2개 이상의 프로세스 혹은 스레드가 임계 영역에 진입하고자 한다면 둘 중 하나는 작업이 끝날때까지 대기해야 한다. 

### 동기화

동기화란 다음의 2가지 조건을 준수하며 실행하는 것을 의미함

- 실행 순서 제어: 프로세스 및 스레드를 올바른 순서로 실행하기
- 상호 배제: 동시에 접근해서는 안되는 자원에 하나의 프로세스 및 스레드만 접근하기

## 동기화 기법

### 뮤텍스 락

뮤텍스 락은 동시에 접근해서는 안되는 자원에 동시 접근이 불가능하도록 상호 배제를 보장하는 동기화 도구이다. 

- 뮤텍스 락의 원리
    
    임계 구역에 접근하고자 한다면 반드시 락(look)을 획득(acquire)해야하고, 임계 구역에서의 작업이 끝났다면 락을 해제(release)해야 한다.
    

전형적인 뮤텍스 락은 프로세스 및 스레드가 공유하는 변수(look)와 2개의 함수(acquire, release)로 구현된다. 

- acquire(): 락을 획득하기 위한 함수로, 특정 락에 대해 한 번만 호출이 가능한 함수이다.
- release(): 획득한 락을 해제하기 위한 함수이다.

- 과정
    
    임계 구역에 진입하려면 프로세스 및 스레드가 공유하는 락을 획득하는 과정이 선행되어야 하므로, 이를 위해 lock.acquire()을 호출한다. 이후 다른 프로세스 및 스레드가 lock.acquire()을 호출해도 락을 획득할 수 없다. 락이 해제될때까지 기다린 후 임계구역의 작업이 끝나면 락을 해제하기 위해 lock.release()를 호출한다. 만약 임계 구역 앞에서 대기하는 프로세스 혹은 스레드가 있었다면 그때서야 비로소 락을 획득하고 임계 구역에 진입한다. 
    

## 세마포

세마포는 공유 자원이 여러 개 있는 상황에서도 동기화가 가능하다. 

### 세마포의 구성 요소

- 변수 S: 사용 가능한 공유 자원의 개수를 나타내는 변수
- wait() 함수: 임계 구역 진입 전 호출하는 함수
- signal() 함수: 임계 구역 진입 후 호출하는 함수

이때 사용가능한 공유 자원의 개수는 임계 구역에 진입할 수 있는 프로세스의 개수와 같다. 뮤텍스 락을 이용할 때 임계 구역 진입 전후로 acquire()과 release() 함수를 호출했듯, 세마포도 임계 구역 진입 전후로 wait()와 signal() 함수를 호출하여 사용한다.

```java
wait()
//임계 구역
signal()
```

### wait() 함수

1. 함수 호출 시 가장 먼저 사용 가능한 공유 자원을 개수를 나타내는 변수 S를 1 감소시킨다.
2. 변수 S의 값이 0보다 작은지 여부를 확인한다. S를 1 감소시켰을 때 S가 0이상일 경우 사용 가능한 공유 자원의 개수가 남아있었음을 의미한다. 이때 wait()를 호출한 프로세스 및 스레드는 임계 구역에 진입한다. 반대로, S를 감소시켰을 때 S가 0미만이라는 것은 사용 가능한 공유 자원의 개수가 남지 않았음을 의미한다. 
3. 따라서 변수 S값이 0보다 작으면 wait()를 호출한 프로세스 및 스레드는 대기 상태로 전환되어 임계 구역에 진입할 수 없게 된다. 

### signal() 함수

1. signal() 함수 호출시 가장 먼저 사용 가능한 공유 자원의 개수를 나타내는 변수 S를 1 증가시킨다.
2. 변수 S의 값이 0 이하인지를 확인하고 S를 1 증가시켰을 때 S가 0보다 크다는 것은 사용 가능한 공유 자원 개수가 1개 이상 남아 있음을 의미하며, 반대로 S를 1 증가시켰을 때 S가 0 이하라는 것은 임계 구역에 진입하기 위해 대기하는 프로세스가 존재함을 의미한다. 
3. 이 경우, 대기 상태로 접어든 프로세스 중 하나를 준비 상태로 전환한다. 

## 조건 변수와 모니터

### 조건 변수

조건 변수란 실행 순서 제어를 위한 동기화 도구로, 특정 조건 하에 프로세스를 실행/일시 중단함으로써 프로세스나 스레드의 실행 순서를 제어할 수 있다. 

조건 변수에 대해 wait()와 signal() 함수를 호출 가능하다.

- 아직 특정 프로세스가 실행될 조건이 되지 않았을 때는 wait()를 통해 실행을 중단한다.
- 특정 프로세스가 실행될 조건이 충족되었을 때는 signal()을 통해 실행을 재개한다.

### 모니터

모니터는 공유자원과 그 공유 자원을 다루는 함수로 구성된 동기화 도구로, 상호 배제를 위한 동기화 뿐만 아니라 실행 순서 제어를 위한 동기화까지 가능하다. 

모니터의 작동 원리

프로세스 및 스레드는 공유 자원에 접근하기 위해 반드시 정해진 공유 자원 연산을 통해 모니터 내로 진입하고 모니터 안에 진입하여 실행되는 프로세스 및 스레드는 항상 하나여야한다. 이미 모니터 내로 진입하여 실행 중인 프로세스 및 스레드가 있다면 큐에서 대기해야한다. 

### 스레드 안전

스레드 안전이란 멀티스레드 환경에서 어떤 변수나 함수, 객체에 동시 접근이 이루어져도 실행에 문제가 없는 상태를 의미한다. 

예를 들어 자바에는 Vector라는 클래스의 add 메서드는 스레드 안전성이 보장되어 있다. 반면 ArrayList라는 함수의 add 메서드는 스레드 안전성이 보장되지 않는다. 

## 교착 상태

교착 상태란 일어나지 않을 사건을 기다리며 프로세스의 진행이 멈춰 버리는 현상이다.

### 교착 상태 발생 조건

교착 상태가 발생하는 상황에는 상호 배제, 점유와 대기, 비선점, 원형 대기 이렇게 4가지 필요 조건이 있다.  

### 상호 배제

교착 상태가 발생하는 근본적인 원인은 한 번에 하나의 프로세스만 해당 지원을 이용 가능했기 때문이다. 즉 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없는 상호 배제의 상황에서 교착 상태가 발생할 수 있다.

### 점유와 대기

한 프로세스가 어떤 자원을 할당 받은 상태에서 다른 자원 할당 받기를 기다린다면 교착상태가 발생할 수 있다. 즉, 점유와 대기의 상황이다.

### 비선점

비선점 또한 교착 상태 발생의 근본적인 문제라고 할 수 있다. 자원이 비선점되었다는 말은 해당 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 자원을 이용할 수 있다는 것을 의미한다. 즉, 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못하는 경우 교착 상태가 발생할 수 있다. 

### 원형 대기

마지막 조건은 프로세스와 프로세스가 요청한 원의 형태를 이루는 경우이다. 

## 교착 상태 해결 방법

### 교착 상태 예방

교착 상태를 예방하는 방법은 앞서 설명한 교착 상태를 발생시키는 4가지 필요 조건 중 하나를 충족하지 못하게 하는 방법이다. 
프로세스의 자원을 할당할 때 상호 배제, 점유와 대기, 비선점, 원형 대기 중 하나라도 만족하지 못하면 교착상태가 발생하지 않기 때문이다. 

### 교착 상태 회피

교착 상태 회피는 교착 상태가 발생하지 않을 정도로만 조심하면서 자원을 할당하는 방법이다. 교착 상태 회피는 기본적으로 한정된 자원의 무분별한 할당으로 인해 발생하는 문제로 간주한다. 

### 교착 상태 검출 후 회복

교착 상태 검출 후 회복은 교착 상태의 발생을 인정하고 처리하는 사후 조치에 해당한다. 이 경우 운영체제는 프로세스가 자원을 요구할 때 마다 그때 그때 자원을 할당하고 주기적으로 교착 상태의 발생 여부를 검사한다. 

그러다 교착 상태가 검출되면 프로세스를 자원 선점을 통해 회복시키거나, 교착 상태에 놓은 프로세스를 강제 종료함으로써 회복시킬 수 있다.