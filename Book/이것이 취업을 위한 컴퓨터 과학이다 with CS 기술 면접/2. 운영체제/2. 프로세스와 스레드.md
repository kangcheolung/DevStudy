# 프로세스와 스레드

### 프로세스 유형

사용자가 보는 공간에서 사용자와 상호작용하며 실행되는 **포그라운드 프로세스**와 사용자가 보지 못하는 공간에서 실행되는 **백그라운드 프로세스**가 있다. 

백그라운드 프로세스 중에서도 사용자와 별다른 상호작용 없이 주어진 작업만 수행하는 특별한 백그라운드 프로세스인 **데몬**도 있다. 
윈도우 운영체제에서는 데몬을 **서비스**라고 부른다.  

커널 영역에는 프로세스 제어 블록(PCB)이라는 정보가 저장되고, 사용자 영역에는 실행 중인 프로세스가 코드 영역, 데이터 영역, 힙 영역, 스택 영역으로 나눠서 저장된다. 

### 코드 영역

코드 영역은 실행 가능한 명령어가 저장되는 공간으로, 텍스트 영역이라고도 부른다. 
CPU가 읽고 실행할 명령어가 담겨 있기 때문에 쓰기가 금지되어 있는 읽기 전용(read-only) 공간이다. 

### 데이터 영역

데이터 영역은 프로그램이 실행되는 동안 유지할 데이터가 저장되는 공간이다. 
데이터 영역에 저장되는 데이터는 정적 변수나 전역 변수가 대표적이다. 

코드 영역과 데이터 영역은 프로그램 도중 크기가 변하지 않기 때문에 정적 할당 영역이라고 부른다. 반면, 크기가 변할 수 있는 힙 영역과 스택 영역은 동적 할당 영역이라고 부른다. 

### 힙 영역

힙 영역은 프로그램을 만드는 사용자(개발자)가 직접 할당 가능한 저장 공간이다. 프로그램 실행 도중 비교적 자유롭게 할당하여 사용 가능한 메모리 공간이라 볼 수 있다. 

다만, 힙 영역에 메모리 공간을 할당했다면 언젠가는 해당 공간을 반환해야 한다. 메모리 공간을 반환하지 않으면 할당한 공간이 계속 메모리에 내에 남아 메모리를 낭비하는 메모리 누수 문제를 초래할 수 있다. 

때로는 이러한 문제를 해결하기 위해 프로그래밍 언어에서 자체적으로 사용되지 않는 힙 메모리를 해체하는 가비지 컬렉션 기능을 제공하기도 한다. 

### 스택 영역

스택 영역은 데이터 영역에 담기는 값과 달리 일시적으로 사용할 값들이 저장되는 공간이다.
함수의 실행이 끝나면 사라지는 매개변수, 지역 변수, 함수 복귀 주소 등이 스택 영역에 저장되는 대표적인 데이터들이다. 

스택 영역에는 스택 트레이스 형태의 함수 호출 정보가 저장될 수 있다는 점을 기억해야 한다. 
스택 트레이스란 특정 시점에 스택 영역에 저장된 함수 호출 정보를 말한다. 

## PCB와 문맥 교환

운영체제가 메모리에 적재된 다수의 프로세스를 관리하려면 프로세스를 식별할 수 있는 커널 영역 내의 정보가 필요하다. 이 정보가 바로 프로세스 제어 블록(PCB)이다. PCB는 프로세스와 관련한 다양한 정보를 내포하는 구조체의 일종으로, 새로운 프로세스가 메모리에 적재됐을 때 커널 영역에 만들어지고, 프로세스의 실행이 끝나면 폐기된다. 

PCB에 담기는 정보는 운영체제마다 차이가 있지만, 대표적으로 프로세스 식별 번호인 프로세스 ID(PID)와 프로세스가 실행 과정에서 사용한 레지스터 값, 프로세스가 현재 어떤 상태인지를 나타내는 프로세스 상태, 프로세스가 언제, 어떤 순서로 CPU를 할당 받을지 나타내는 CPU 스케줄링(우선 순위) 정보, 프로세스의 메모리상 작재 위치를 알 수 있는 메모리 관련 정보, 프로세스가 사용한 파일 및 입출력장치 관련 정보가 명시된다. 

이때 여러 PCB들은 커널 내에 프로세스 테이블 형태로 관리되는 경우가 많다. 

### 문맥 교환 예시

프로세스의 CPU 사용 시간은 타이머 인터럽트에 의해 제한된다.  
타이머 인터럽트란 시간이 끝났음을 알리는 인터럽트로, 타임아웃 인터럽트 라고도 부른다. 
프로세스는 자신의 차례가 되면 정해진 시간만큼 CPU를 이용하고, 타이머 인터럽트가 발생하면 자신의 차례를 양보하고 다음 차례가 올 때까지 기다립니다. 

예를 들어 프로세스 A가 운영체제로부터 CPU를 할당받아 실행되다가, 타이머 인터럽트가 발생하여 프로세스 B로 CPU 사용을 양보한다고 가정해 봅시다.

이때 프로세스 A는 프로그램 카운터를 비롯한 각종 레지스터 값과 메모리 정보, 실행을 위해 열었던 파일 등 지금까지의 중간 정보를 백업해야 한다. 그래야 다음에 다시 프로세스 A를 실행할 차례가 됐을때 이전까지 실행했던 내용을 이어서 재개할 수 있기 때문이다. 

여기서 백업 대상이 되는 중간 정보, 즉 프로세스의 수행을 재개하기 위해 기억해야하는 정보를 문맥이라고 한다. 프로세스 문맥은 PCB에 명시된다.  프로세스가 CPU를 사용할 수 있는 시간이 다 되거나 인터럽트가 발생하면 운영체제는 해당 프로세스의 PCB에 문맥을 백업하고 뒤이어 실행할 프로세스의 문맥을 복구한다. 

이처럼 기존 프로세스의 문맥을 PCB에 백업하고, PCB 문맥을 복구하여 새로운 프로세스를 실행하는 것을 문맥 교환이라고 한다. 

### 문맥교환은 많으면 좋을까?

결론부터 말하면 좋지 않다. 프로세스 간에 너무 잦은 문맥 교환이 발생하면 캐시 미스가 발생할 가능성이 높아져 메모리로부터 실행할 프로세스의 내용을 가져오는 작업이 빈번해지고, 이는 큰 오버해드로 이어질 수 있기 때문이다. 

## 프로세스 상태

하나의 프로세스는 여러상태를 거치며 실행된다. 운영체제는 PCB를 통해 프로세스의 상태를 인식하고 관리한다. 
운영체제 마다 프로세스의 상태를 표현하는 방식은 조금씩 차이가 있지만, 대표적으로는 생성, 준비, 실행, 대기, 종료 등이 있다. 

### 생성

프로세스를 생성 중인 상태로, 메모리에 적재되어 PCB를 할당 받은 상태이다. 생성 상태를 거쳐 실행할 준비가 완료된 프로세스는 준비 상태가 되어 CPU의 할당을 기다린다. 

### 준비 상태

당장이라도 CPU를 할당받아 실행할 수 있지만, 아직 자신의 차례가 아니기 때문에 기다리고 있는 상태를 말한다. 
준비상태인 프로세스가 CPU를 할당 받으면 실행 상태가 되며, 준비 상태인 프로세스가 실행 상태로 전환하는 것을 디스패치라고 한다. 

### 실행 상태

실행 상태는 CPU를 할당 받아 실행 중인 상태로, 일정 시간 동안만 CPU를 사용할 수 있다. 타이머 인터럽트가 발생하여 프로세스가 할당된 시간을 모두 사용하면 다시 준비 상태가되고, 실행 도중 입출력장치를 사용하여 입출력장치의 작업이 끝날때까지 기다려야하면 대기 상태가 된다. 

### 대기 상태

프로세스가 입출력 작업을 요청하거나 바로 확보할 수 없는 자원을 요청하는 등 곧장 실행이 불가능한 조건에 놓이는 경우 대기 상태가 된다. 대기 상태로 전환되는 상황은 다양하지만, 입출력 작업을 요청하는 경우가 대표적이다. 대기 상태였던 해당 프로세스는 입출력 작업이 완료되는 등 실행 가능한 상태가 되면 다시 준비 상태가 되어 CPU 할당을 기다린다. 

### 종료 상태

종료 상태는 프로세스가 종료된 상태를 말한다. 프로세스가 종료되면 운영체제는 PCB와 프로세스가 사용한 메모리를 정리한다. 

## 멀티프로세스와 멀티 스레드

### 멀티 프로세스

- 멀티프로세스는 동시에 여러 프로세스가 실행되는 것이다.
- 각기 다른 프로세스들이 기본적으로 자원을 공유하지 않고, 독립적으로 실행된다. 
같은 작업을 수행해도 각각의 PID, 파일과 입출력장치 등의 자원이 독립적으로 할당되어 다른 프로세스에 영향을 거의 끼치지 않는다.
- 한 프로세스의 실행 과정에 문제가 생겨도 다른 프로세스에 직접적인 영향을 끼치지 않는 경우가 많다.

### 멀티 스레드

- 멀티 스레드는 프로세스를 동시에 실행하는 여러 스레드를 말한다.

### 차이점

멀티프로세스와 멀티 스레드의 가장 큰 차이점은 자원의 공유 여부이다. 
서로 다른 프로세스들은 기본적으로 자원을 공유하지 않기 때문에 독립적으로 실행되는 반면, 같은 프로세스를 실행하는 여러 스레드들은 프로세스의 자원을 공유한다. 스레드들은 동일한 주소 공간의 코드, 데이터, 힙 영역을 공유하고, 열린 파일과 같은 프로세스의 자원을 공유하기 때문에 쉽게 협력하고 통신할 수 있다. 다만, 멀티프로세스 환경에서는 한 프로세스에 문제가 생겨도 다른 프로세스에 지장이 없지만, 멀티스레드 환경에서는 한 스레드에 생긴 문제가 프로세스 전체에 문제가 될 수 있다. 

## 프로세스 간 통신

프로세스는 기본적으로 자원을 공유하지 않지만, 프로세스 간에도 자원을 공유하고 데이터를 주고 받을 수 있는 방법이 있다. 이를 프로세스 간 통신(IPC)라고 부른다. 

프로세스 간 통신이 이루어지는 방식은 크게 공유 메모리와 메세지 전달이 있다.

- 공유 메모리: 말 그대로 데이터를 주고 받는 프로세스가 공통적으로 사용할 메모리 영역
- 메세지 전달: 프로세스 간에 주고받을 데이터를 메세지의 형태로 주고 받는 방식

### 공유 메모리

공유 메모리는 프로세스 간에 공유하는 메모리 영역을 토대로 데이터를 주고 받는 통신 방식이다. 

### 특징

- 통신을 주고 받는 각 프로세스가 마치 자신의 메모리 영역을 읽고 쓰는 것처럼 통신한다
- 프로세스가 데이터를 주고받는 과정에 커널의 개입이 거의 없다
- 각각의 프로세스가 서로 공유한 메모리 영역을 동시에 읽고 쓸 경우, 데이터의 일관성이 훼손될 수 있다.

### 메세지 전달

메세지 전달은 프로세스 간에 주고 받을 데이터가 커널을 거쳐 송수신되는 통신 방식이다. 

### 특징

- 메세지 전달 기반 IPC는 메세지를 보내는 수단과 받는 수단이 명확하게 구분되어 있다.
- 데이터를 주고 받는 프로세스의 입장에서 메세지 전달 기반 IPC는 공유 메모리 기반 IPC보다 커널의 도움을 적극적으로 받을 수 있으므로 레이스 컨디션, 동기화 등의 문제를 고랴하는 일이 상대적으로 적다.
- 주고받는 데이터가 커널을 통해 송수신되므로 공유 메모리 기반 IPC보다 통신 속도가 느리다.

메세지 전달 기반 IPC를 위한 대표적인 수단으로는 파이프, 시그널, 소켓, 원격 프로시저 호출 등이 있다. 

### 파이프

파이프는 단방향 프로세스 간의 통신 도구를 말한다. 

### 시그널

시그널은 프로세스에게 특정 이벤트가 발생했음을 알리는 비동기적인 신호이다.